<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Task List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body class="bg-black text-white d-flex justify-content-center align-items-center text-left vh-100">
    <div>
        <ul id="task-list-todo" class="fs-6 list-group opacity-75 justify-content-end align-items-center" style="height: 40vh;"></ul>
        <ul id="task-list-doing" class="fs-3 list-group my-4 justify-content-center align-items-center" style="height: 20vh;"></ul>
        <ul id="task-list-done" class="fs-6 list-group opacity-50 justify-content-top align-items-center" style="height: 40vh;"></ul>
    </div>
</body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script><script src="../../../public/enums?name=statusTask"></script>
<script type="text/javascript">
    var tasks = [];
    function elementToInput(id, btn) {
        const element = document.getElementById(id);
        const input = document.createElement('input');
        input.type = 'text';
        input.classList.add('mt-1', 'bg-black', 'border-white', 'border-1', 'rounded', 'text-white');
        input.style.width = '80vw';
        input.value = element.innerText;
        input.dataset.value = element.dataset.value;
        input.dataset.key = element.dataset.key;
        input.elementClass = element.classList.value;
        element.parentElement.replaceChild(input, element);
        input.focus();
        btn.innerHTML = '<i class="bi bi-check-lg"></i>';
        btn.onclick = () => { inputToElement(input, id, btn); }
    }
    function inputToElement (input, id, btn) {
        const element = document.createElement('span');
        element.id = id;
        element.innerText = input.value;
        element.dataset.value = input.value;
        element.dataset.key = input.dataset.key;
        element.classList.value = input.elementClass;
        input.parentElement.replaceChild(element, input);
        btn.innerHTML = '<i class="bi bi-pencil-fill"></i>';
        btn.onclick = () => { elementToInput(id, btn); }
        let task = tasks.find(task => task.id == id.split('-')[2]);
        task[element.dataset.key] = element.dataset.value;
        updateTask(task);
    }
    function taskItemComponent(task, li){
        li.innerHTML = `
            <input data-key="idStatus" data-value="${task.idStatus}" class="form-check-input bg-black border-white" type="checkbox" id="task-${task.id}" onChange="updateTaskStatus(this)" ${task.idStatus == StatusTask.DONE ? 'checked' : ''}/> 
            <div style="width:fit-content" for="task-${task.id}">
                <span title="Deadline" data-key="deadline" data-value="${task.deadline}" class="deadline text-left" >${task.deadline ? moment(task?.deadline).format("DD/MM | HH:mm") + '' : ''}</span>
                ${task.idStatus == StatusTask.DOING ? '<button class="btn btn-sm btn-outline-light" onClick="startClock(this)"><i class="bi bi-alarm-fill"></i></button>' : ''} <br>
                <span data-key="title" data-value="${task.title}" id="task-title-${task.id}">${task.title}</span>
                <span class="rounded-circle btn btn-outline-light btn-edit" onClick="elementToInput('task-title-${task.id}', this)">
                    <i class="bi bi-pencil-fill"></i>
                </span><br> 
                <span data-key="description" data-value="${task.description}" class="text-little opacity-75" id="task-description-${task.id}">${task.description || 'Description'}</span>
                <span class="rounded-circle btn btn-outline-light btn-edit" onClick="elementToInput('task-description-${task.id}', this)">
                    <i class="bi bi-pencil-fill"></i>
                </span>
            </div>`;
        li.classList.add('d-flex', 'align-items-center', 'gap-3', 'my-1');
        return li;
    }
    function updateTaskStatus(element) {
        const id = element.id.split('-')[1];
        const status = element.checked ? 3 : 1;
        element.dataset.value = status;
        let task = tasks.find(task => task.id == id);
        task[element.dataset.key] = parseInt(element.dataset.value);
        updateTask(task);
        const taskElement = document.getElementById(`task-${task.id}`).parentElement
        taskElement.remove();
        taskItemComponent(task, taskElement);
        switch (task.idStatus) {
            case StatusTask.TODO:
                document.getElementById('task-list-todo').appendChild(taskElement);
                break;
            case StatusTask.DOING:
                document.getElementById('task-list-doing').appendChild(taskElement);
                break;
            case StatusTask.DONE:
                document.getElementById('task-list-done').appendChild(taskElement);
                break;
        }
    }
    async function updateTask(task) {
        const response = await axios.put(`http://localhost:3010/api/tasks/`, {
            ...task
        });
        task = response.data;
    }
    async function getTasks() {
        const taskListTodo = document.getElementById('task-list-todo');
        const taskListDoing = document.getElementById('task-list-doing');
        const taskListDone = document.getElementById('task-list-done');
        const response = await axios.get('http://localhost:3010/api/tasks');
        tasks = response.data;
        tasks.sort((a, b) => b.id - a.id);
        tasks.forEach(task => {
            const li = document.createElement('li');
            taskItemComponent(task, li);
            switch (task.idStatus) {
                case StatusTask.TODO:
                    taskListTodo.appendChild(li);
                    break;
                case StatusTask.DOING:
                    taskListDoing.appendChild(li);
                    break;
                case StatusTask.DONE:
                    taskListDone.appendChild(li);
                    break;
            }
        });
    }
    getTasks();

    let workerCount;
    let clockActive = false;
    let secondsCount = 0;
    let minutesCount = 0;
    let hoursCount = 0;
    let elementDate;
    async function startClock(element) {
        if(isNaN(parseInt(element.innerText))){
            element.innerText = '00:00:00';
        }
        element.classList.remove('btn-outline-light');
        element.classList.add('btn-light');
        clockActive = !clockActive;
        if(!clockActive){
            workerCount.terminate();
            element.classList.remove('btn-light');
            element.classList.add('btn-outline-light');
            return;
        }
        workerCount = new Worker('public/counter.js');
        elementDate = moment(element.innerText, 'HH:mm:ss')
        secondsCount = elementDate.seconds();
        minutesCount = elementDate.minutes();
        hoursCount = elementDate.hours();
        element.secondsCount = secondsCount + (minutesCount * 60) + (hoursCount * 3600);
        workerCount.postMessage(parseInt(element.secondsCount) == 0 ? 0 : parseInt(element.secondsCount)+1);
        workerCount.onmessage = function (e) {
            let secondsCount = e.data == 1 ? e.data + element.secondsCount : e.data;
            element.innerText = moment().startOf('day').seconds(secondsCount).format('HH:mm:ss');
        }
    }
</script>
<style>
    li::marker {
        color: transparent;
    }
    .text-little {
        font-size: 80%;
    }
    .deadline {
        font-size: 50%;
    }
    .btn-edit {
        transform: scale(0.5);
        opacity: 0;
        margin-bottom: -5px;
        margin-top: -8px;
    }
    span:hover + .btn-edit, input:hover + .btn-edit, .btn-edit:hover {
        opacity: 1;
    }
</style>
</html>